// app/api/rss/route.ts\nimport { NextResponse } from 'next/server'\nimport { sanityClient as client } from '@/lib/sanity'\n\nexport const dynamic = 'force-static'\nexport const revalidate = 3600 // Revalidate every hour\n\nexport async function GET() {\n  try {\n    // Fetch latest posts from Sanity\n    const posts = await client.fetch(`*[_type == \"berita\" || _type == \"pengumuman\"] | order(date desc)[0..20]{\n      _id,\n      title,\n      slug,\n      excerpt,\n      date,\n      body,\n      author->{\n        name\n      },\n      _type\n    }`)\n    \n    // Generate RSS XML\n    const rss = generateRSS(posts)\n    \n    return new NextResponse(rss, {\n      headers: {\n        'Content-Type': 'application/xml',\n      },\n    })\n  } catch (error) {\n    console.error('RSS feed generation error:', error)\n    return new NextResponse('Error generating RSS feed', { status: 500 })\n  }\n}\n\nfunction generateRSS(posts: any[]) {\n  const siteUrl = process.env.NEXT_PUBLIC_SITE_URL || 'https://www.malnukananga.sch.id'\n  const lastBuildDate = new Date().toUTCString()\n  \n  const items = posts.map(post => {\n    const postUrl = `${siteUrl}/${post._type === 'pengumuman' ? 'pengumuman' : 'berita'}/${post.slug.current}`\n    const pubDate = new Date(post.date).toUTCString()\n    \n    // Convert first paragraph of body to description\n    let description = post.excerpt || ''\n    if (!description && post.body && post.body.length > 0) {\n      const firstBlock = post.body[0]\n      if (firstBlock._type === 'block' && firstBlock.children) {\n        description = firstBlock.children.map((child: any) => child.text).join('')\n      }\n    }\n    \n    return `\n    <item>\n      <title><![CDATA[${escapeXml(post.title)}]]></title>\n      <description><![CDATA[${escapeXml(description)}]]></description>\n      <link>${postUrl}</link>\n      <guid isPermaLink=\"true\">${postUrl}</guid>\n      <pubDate>${pubDate}</pubDate>\n      <author><![CDATA[${escapeXml(post.author?.name || 'Admin MA Malnu Kananga')}]]></author>\n    </item>`\n  }).join('')\n  \n  return `<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<rss version=\"2.0\" xmlns:atom=\"http://www.w3.org/2005/Atom\">\n  <channel>\n    <title>MA Malnu Kananga - Berita & Pengumuman</title>\n    <description>Berita dan pengumuman terkini dari MA Malnu Kananga</description>\n    <link>${siteUrl}</link>\n    <language>id-ID</language>\n    <lastBuildDate>${lastBuildDate}</lastBuildDate>\n    <atom:link href=\"${siteUrl}/api/rss\" rel=\"self\" type=\"application/rss+xml\" />\n    ${items}\n  </channel>\n</rss>`\n}\n\nfunction escapeXml(unsafe: string) {\n  if (!unsafe) return ''\n  return unsafe.replace(/[<>&'\"/g, (c) => {\n    switch (c) {\n      case '<': return '&lt;'\n      case '>': return '&gt;'\n      case '&': return '&amp;'\n      case '\\''': return '&apos;'\n      case '\"': return '&quot;'\n      default: return c\n    }\n  })\n}