name: Label and Project Management

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'setup-labels'
        type: choice
        options:
          - setup-labels
          - sync-projects
          - cleanup-old
  schedule:
    # Run weekly on Sunday at 2 AM
    - cron: '0 2 * * 0'
  issues:
    types: [labeled, opened, closed]

jobs:
  setup-labels:
    name: Setup Repository Labels
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'setup-labels' || github.event_name == 'schedule'
    permissions:
      issues: write
      labels: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup labels from config
        uses: actions/github-script@v7
        with:
          script: |
            const labelsConfig = {
              # Priority Labels
              "priority/critical": { color: "b60205", description: "Critical priority - blocks core functionality or security" },
              "priority/high": { color: "d93f0b", description: "High priority - affects many users or important features" },
              "priority/medium": { color: "fbca04", description: "Medium priority - normal feature/bug work" },
              "priority/low": { color: "7057ff", description: "Low priority - minor improvements or nice-to-haves" },
              
              # Type Labels
              "bug": { color: "d73a4a", description: "Something isn't working" },
              "enhancement": { color: "a2eeef", description: "New feature or improvement" },
              "feature-request": { color: "84b6eb", description: "Request for new functionality" },
              "documentation": { color: "0075ca", description: "Improvements or additions to documentation" },
              "performance": { color: "1d76db", description: "Performance issues or optimizations" },
              "security": { color: "ee0701", description: "Security vulnerabilities or concerns" },
              
              # Status Labels
              "status/triage": { color: "ededed", description: "Needs triage and prioritization" },
              "status/in-progress": { color: "f9d0c4", description: "Currently being worked on" },
              "status/review": { color: "fef2c0", description: "Awaiting review or feedback" },
              "status/done": { color: "c2e0c6", description: "Completed and resolved" },
              "status/blocked": { color: "d4c5f9", description: "Blocked by dependencies or issues" },
              "status/needs-info": { color: "f6f8fa", description: "Needs more information from reporter" },
              
              # Component Labels
              "component/ppdb": { color: "5319e7", description: "Related to PPDB registration system" },
              "component/frontend": { color: "0366d6", description: "Frontend components and UI" },
              "component/backend": { color: "1a202c", description: "Backend API and server logic" },
              "component/database": { color: "586069", description: "Database schema and queries" },
              "component/deployment": { color: "e99695", description: "Deployment and infrastructure" },
              "component/seo": { color: "c5def5", description: "SEO and metadata optimization" },
              "component/accessibility": { color: "006b75", description: "Accessibility and WCAG compliance" },
              
              # Size Labels
              "size/small": { color: "c7def8", description: "Small task (1-3 hours)" },
              "size/medium": { color: "c2e0c6", description: "Medium task (3-8 hours)" },
              "size/large": { color: "fbca04", description: "Large task (8+ hours)" },
              
              # Special Labels
              "good first issue": { color: "7057ff", description: "Good for newcomers" },
              "help wanted": { color: "008672", description: "Community help needed" },
              "wontfix": { color: "ffffff", description: "Will not be fixed or implemented" },
              "duplicate": { color: "cfd3d7", description: "Duplicate of another issue" },
              "question": { color: "d876e3", description: "Question or clarification needed" },
              
              # Educational Context Labels
              "context/student-facing": { color: "b1e4b3", description: "Visible to students" },
              "context/parent-facing": { color: "ffdab9", description: "Visible to parents/guardians" },
              "context/admin-facing": { color: "e4b3ff", description: "For school administrators" },
              "context/teacher-facing": { color: "b3d9ff", description: "For teachers and staff" },
              
              # Automation Labels
              "automation": { color: "f6f8fa", description: "Automatically generated by workflows" },
              "stale": { color: "f6f8fa", description: "No recent activity" },
              "weekly-summary": { color: "f6f8fa", description: "Weekly activity summary" }
            };
            
            // Get existing labels
            const existingLabels = await github.rest.issues.listLabelsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            
            const existingLabelNames = existingLabels.data.map(l => l.name);
            
            // Create missing labels
            for (const [name, config] of Object.entries(labelsConfig)) {
              if (!existingLabelNames.includes(name)) {
                try {
                  await github.rest.issues.createLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    name: name,
                    color: config.color,
                    description: config.description
                  });
                  console.log(`Created label: ${name}`);
                } catch (error) {
                  console.log(`Failed to create label ${name}: ${error.message}`);
                }
              }
            }
            
            console.log('Label setup complete!');

  project-board-sync:
    name: Sync Project Boards
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'sync-projects' || github.event_name == 'issues'
    permissions:
      issues: write
      projects: write
      
    steps:
      - name: Sync issues to project boards
        uses: actions/github-script@v7
        with:
          script: |
            // This would require GitHub Projects API integration
            // For now, we'll create a comment that guides manual project board setup
            if (github.event_name === 'issues') {
              const issue = context.payload.issue;
              const labels = issue.labels.map(l => l.name);
              
              // Determine which project board this should go to
              let projectBoard = 'Backlog';
              if (labels.includes('priority/critical') || labels.includes('priority/high')) {
                projectBoard = 'Active Sprint';
              } else if (labels.includes('bug')) {
                projectBoard = 'Bug Tracking';
              } else if (labels.includes('component/ppdb')) {
                projectBoard = 'PPDB System';
              }
              
              // Add comment with project board suggestion
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `## ðŸ“‹ Project Board Suggestion\n\nThis issue should be added to: **${projectBoard}**\n\n### Recommended Boards:\n- ðŸŽ¯ **Active Sprint** - For high priority work\n- ðŸ› **Bug Tracking** - For bug fixes\n- ðŸŽ“ **PPDB System** - For registration system issues\n- ðŸ“š **Backlog** - For future work\n\n*Please add this issue to the appropriate project board manually.*`
              });
            }

  cleanup-old-issues:
    name: Cleanup Old Issues
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'cleanup-old' || github.event_name == 'schedule'
    permissions:
      issues: write
      pull-requests: write
      
    steps:
      - name: Cleanup old stale issues
        uses: actions/github-script@v7
        with:
          script: |
            const ninetyDaysAgo = new Date();
            ninetyDaysAgo.setDate(ninetyDaysAgo.getDate() - 90);
            const isoDate = ninetyDaysAgo.toISOString();
            
            // Get old issues without recent activity
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              sort: 'updated',
              direction: 'asc'
            });
            
            const oldIssues = issues.data.filter(issue => 
              !issue.pull_request &&
              new Date(issue.updated_at) < ninetyDaysAgo &&
              !issue.labels.some(l => ['priority/critical', 'priority/high', 'security'].includes(l.name))
            );
            
            for (const issue of oldIssues) {
              // Add stale label if not already present
              if (!issue.labels.some(l => l.name === 'stale')) {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  labels: ['stale']
                });
                
                // Add comment
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: `## âš ï¸ Issue Marked as Stale\n\nThis issue has been automatically marked as stale because it has been open for over 90 days without recent activity.\n\n### Next Steps:\n- ðŸ”„ Add a comment with updates to keep it active\n- âœ… Close if no longer relevant\n- ðŸŽ¯ Update priority or assign if still needed\n\nThis issue will be closed in 30 days if no activity occurs.\n\n---\n*This is an automated message. You can remove the \`stale\` label to keep this issue active.*`
                });
              }
            }
            
            console.log(`Processed ${oldIssues.length} old issues`);

  label-analytics:
    name: Generate Label Analytics
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    permissions:
      issues: read
      
    steps:
      - name: Generate label usage report
        uses: actions/github-script@v7
        with:
          script: |
            // Get all open issues
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });
            
            const openIssues = issues.data.filter(i => !i.pull_request);
            
            // Count label usage
            const labelCounts = {};
            openIssues.forEach(issue => {
              issue.labels.forEach(label => {
                labelCounts[label.name] = (labelCounts[label.name] || 0) + 1;
              });
            });
            
            // Sort by usage
            const sortedLabels = Object.entries(labelCounts)
              .sort(([,a], [,b]) => b - a)
              .slice(0, 20); // Top 20 labels
            
            const report = `## ðŸ“Š Label Usage Analytics\n\n**Generated**: ${new Date().toLocaleDateString()}\n**Total Open Issues**: ${openIssues.length}\n\n### ðŸ·ï¸ Most Used Labels (Top 20)\n\n| Label | Count | Percentage |\n|-------|-------|------------|\n${sortedLabels.map(([label, count]) => 
  `| ${label} | ${count} | ${((count / openIssues.length) * 100).toFixed(1)}% |`
).join('\n')}\n\n### ðŸ“ˆ Insights\n\n- ðŸŽ¯ **Most Common Priority**: ${Object.entries(labelCounts).find(([name]) => name.startsWith('priority/'))?.[0] || 'None'}\n- ðŸ§© **Most Active Component**: ${Object.entries(labelCounts).find(([name]) => name.startsWith('component/'))?.[0] || 'None'}\n- ðŸ“Š **Most Common Status**: ${Object.entries(labelCounts).find(([name]) => name.startsWith('status/'))?.[0] || 'None'}\n\n### ðŸ’¡ Recommendations\n\n${labelCounts['status/triage'] > 5 ? `- ðŸ“‹ **${labelCounts['status/triage']} issues** need triage - consider scheduling triage session` : ''}\n${labelCounts['priority/critical'] > 0 ? `- ðŸ”´ **${labelCounts['priority/critical']} critical issues** need immediate attention` : ''}\n${labelCounts['status/in-progress'] > 10 ? `- ðŸ”„ **${labelCounts['status/in-progress']} issues** in progress - check for bottlenecks` : ''}\n\n---\n*Generated automatically on ${new Date().toLocaleString()}*`;
            
            // Create analytics issue
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ“Š Label Analytics - ${new Date().toLocaleDateString()}`,
              body: report,
              labels: ['automation', 'analytics']
            });