name: Dependency Management

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run dependency audit daily at 2 AM Jakarta time
    - cron: '0 19 * * *'  # 2 AM Jakarta time = 19:00 UTC
  workflow_dispatch:

jobs:
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run security audit
        run: npm audit --audit-level moderate
        continue-on-error: true

- name: Check for known vulnerabilities
        run: |
          LOW_VULNS=$(npm audit --json | jq '[.vulnerabilities[] | select(.severity == "low")] | length')
          MODERATE_VULNS=$(npm audit --json | jq '[.vulnerabilities[] | select(.severity == "moderate")] | length')
          HIGH_VULNS=$(npm audit --json | jq '[.vulnerabilities[] | select(.severity == "high")] | length')
          CRITICAL_VULNS=$(npm audit --json | jq '[.vulnerabilities[] | select(.severity == "critical")] | length')
          
          echo "ðŸ” Security Audit Results:"
          echo "   Low: $LOW_VULNS"
          echo "   Moderate: $MODERATE_VULNS"
          echo "   High: $HIGH_VULNS"
          echo "   Critical: $CRITICAL_VULNS"
          
          # Fail only if there are moderate or higher severity vulnerabilities
          if [ "$MODERATE_VULNS" -gt 0 ] || [ "$HIGH_VULNS" -gt 0 ] || [ "$CRITICAL_VULNS" -gt 0 ]; then
            echo "âš ï¸ Security vulnerabilities found!"
            echo "âŒ Failing because of moderate or higher severity vulnerabilities"
            npm audit --json
            exit 1
          else
            echo "âœ… No moderate or higher severity vulnerabilities found"
            echo "âœ… Low severity vulnerabilities are acceptable for now"
          fi

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate
          allow-ghsas: |
            GHSA-xxxx-xxxx-xxxx
          deny-ghsas: |
            GHSA-xxxx-xxxx-xxxx

  outdated-check:
    name: Check Outdated Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check outdated packages
        run: |
          echo "## Outdated Dependencies Report" >> $GITHUB_STEP_SUMMARY
          echo "Generated on: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          npm outdated || true >> $GITHUB_STEP_SUMMARY

  lockfile-maintenance:
    name: Lockfile Maintenance
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' && github.event.schedule == '0 19 * * *'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Update npm
        run: npm install -g npm@latest

      - name: Install dependencies
        run: npm ci

      - name: Update lockfile
        run: npm update --save

      - name: Check for changes
        id: verify-changed-files
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit changes
        if: steps.verify-changed-files.outputs.changed == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add package-lock.json
          git commit -m "chore: update lockfile [skip ci]"
          git push