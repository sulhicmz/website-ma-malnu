name: Repository Health Check

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/health-check.yml'

jobs:
  health-check:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci --legacy-peer-deps
        
      - name: Check package.json health
        run: |
          echo "ğŸ“¦ Checking package.json health..."
          
          # Check for outdated dependencies
          npx npm-check-updates --version
          
          # Check for security vulnerabilities
          npm audit --audit-level moderate
          
          # Check package size
          npx bundlesize
          
      - name: Check code quality metrics
        run: |
          echo "ğŸ” Checking code quality..."
          
          # Run ESLint with coverage
          npm run lint -- --format=json --output-file=eslint-report.json
          
          # Check TypeScript coverage
          npm run type-check
          
          # Check test coverage
          npm run test -- --coverage --coverageReporters=json-summary
          
      - name: Check documentation completeness
        run: |
          echo "ğŸ“š Checking documentation..."
          
          # Check if README is comprehensive
          if [ -f "README.md" ]; then
            echo "âœ… README.md exists"
            # Check for essential sections
            if grep -q "## Installation" README.md && grep -q "## Usage" README.md; then
              echo "âœ… README has essential sections"
            else
              echo "âš ï¸ README missing essential sections"
            fi
          else
            echo "âŒ README.md missing"
          fi
          
          # Check API documentation
          if [ -f "API.md" ]; then
            echo "âœ… API.md exists"
          else
            echo "âš ï¸ API.md missing"
          fi
          
          # Check security documentation
          if [ -f "SECURITY.md" ]; then
            echo "âœ… SECURITY.md exists"
          else
            echo "âŒ SECURITY.md missing"
          fi
          
      - name: Check GitHub configurations
        run: |
          echo "âš™ï¸ Checking GitHub configurations..."
          
          # Check CODEOWNERS
          if [ -f ".github/CODEOWNERS" ]; then
            echo "âœ… CODEOWNERS exists"
          else
            echo "âŒ CODEOWNERS missing"
          fi
          
          # Check Dependabot config
          if [ -f ".github/dependabot.yml" ]; then
            echo "âœ… Dependabot config exists"
          else
            echo "âŒ Dependabot config missing"
          fi
          
          # Check issue templates
          if [ -d ".github/ISSUE_TEMPLATE" ]; then
            echo "âœ… Issue templates exist"
            echo "ğŸ“‹ Available templates:"
            ls .github/ISSUE_TEMPLATE/
          else
            echo "âš ï¸ No issue templates found"
          fi
          
          # Check workflows
          if [ -d ".github/workflows" ]; then
            echo "âœ… Workflows exist"
            echo "ğŸ”„ Available workflows:"
            ls .github/workflows/
          else
            echo "âŒ No workflows found"
          fi
          
      - name: Check performance metrics
        run: |
          echo "âš¡ Checking performance metrics..."
          
          # Build project
          npm run build
          
          # Check bundle size
          if [ -f ".next/analyze/client.html" ]; then
            echo "âœ… Bundle analysis available"
          else
            echo "âš ï¸ Run 'npm run build:analyze' for bundle analysis"
          fi
          
          # Check Lighthouse config
          if [ -f "lighthouserc.js" ]; then
            echo "âœ… Lighthouse CI configured"
          else
            echo "âš ï¸ Lighthouse CI not configured"
          fi
          
      - name: Generate health report
        run: |
          echo "ğŸ“Š Generating health report..."
          
          cat > health-report.md << 'EOF'
          # Repository Health Report
          
          Generated on: $(date)
          
          ## ğŸ“¦ Dependencies
          - Security audit: $(npm audit --audit-level moderate --json | jq -r '.metadata.vulnerabilities.total // 0') vulnerabilities found
          - Outdated packages: Check with `npm outdated`
          
          ## ğŸ” Code Quality
          - ESLint: $(npm run lint 2>&1 | grep -c "error" || echo "0") errors
          - TypeScript: $(npm run type-check 2>&1 | grep -c "error" || echo "0") errors
          - Test coverage: Check coverage reports
          
          ## ğŸ“š Documentation
          - README: $([ -f "README.md" ] && echo "âœ…" || echo "âŒ")
          - API docs: $([ -f "API.md" ] && echo "âœ…" || echo "âŒ")
          - Security policy: $([ -f "SECURITY.md" ] && echo "âœ…" || echo "âŒ")
          
          ## âš™ï¸ GitHub Configuration
          - CODEOWNERS: $([ -f ".github/CODEOWNERS" ] && echo "âœ…" || echo "âŒ")
          - Dependabot: $([ -f ".github/dependabot.yml" ] && echo "âœ…" || echo "âŒ")
          - Issue templates: $([ -d ".github/ISSUE_TEMPLATE" ] && echo "âœ…" || echo "âŒ")
          
          ## âš¡ Performance
          - Build status: $([ -d ".next" ] && echo "âœ…" || echo "âŒ")
          - Bundle analysis: $([ -f ".next/analyze/client.html" ] && echo "âœ…" || echo "âŒ")
          - Lighthouse CI: $([ -f "lighthouserc.js" ] && echo "âœ…" || echo "âŒ")
          
          ## ğŸ·ï¸ Recommendations
          - [ ] Address any security vulnerabilities
          - [ ] Update outdated dependencies
          - [ ] Improve test coverage
          - [ ] Add missing documentation
          - [ ] Optimize bundle size
          EOF
          
          echo "ğŸ“„ Health report generated"
          
      - name: Upload health report
        uses: actions/upload-artifact@v4
        with:
          name: health-report
          path: health-report.md
          
      - name: Create issue for health check results
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            if (fs.existsSync('health-report.md')) {
              const report = fs.readFileSync('health-report.md', 'utf8');
              
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ğŸ¥ Repository Health Check - ${new Date().toISOString().split('T')[0]}`,
                body: report,
                labels: ['type/maintenance', 'priority/medium']
              });
            }