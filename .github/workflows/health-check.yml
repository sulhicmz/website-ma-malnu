name: Repository Health Monitoring

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run health check daily at 6 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:

jobs:
  health-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci --legacy-peer-deps
      
    - name: Check repository structure
      run: |
        echo "# üè• Repository Health Report" > health-report.md
        echo "Generated on: $(date)" >> health-report.md
        echo "" >> health-report.md
        
        echo "## üìÅ Repository Structure" >> health-report.md
        echo "" >> health-report.md
        
        # Check essential files
        echo "### Essential Files Check:" >> health-report.md
        files=("README.md" "package.json" ".gitignore" "next.config.js" "tailwind.config.js" "tsconfig.json")
        for file in "${files[@]}"; do
          if [ -f "$file" ]; then
            echo "- ‚úÖ $file" >> health-report.md
          else
            echo "- ‚ùå $file (missing)" >> health-report.md
          fi
        done
        
        # Check essential directories
        echo "" >> health-report.md
        echo "### Essential Directories Check:" >> health-report.md
        dirs=("src" "components" "public" ".github" "docs")
        for dir in "${dirs[@]}"; do
          if [ -d "$dir" ]; then
            echo "- ‚úÖ $dir/" >> health-report.md
          else
            echo "- ‚ùå $dir/ (missing)" >> health-report.md
          fi
        done
        
    - name: Check code quality metrics
      run: |
        echo "" >> health-report.md
        echo "## üìä Code Quality Metrics" >> health-report.md
        echo "" >> health-report.md
        
        # Count lines of code
        echo "### Code Statistics:" >> health-report.md
        echo "- **Total TypeScript/JavaScript files**: $(find . -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx" | grep -v node_modules | wc -l)" >> health-report.md
        echo "- **Total lines of code**: $(find . -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx" | grep -v node_modules | xargs wc -l | tail -1)" >> health-report.md
        echo "- **Components count**: $(find . -name "*.tsx" -o -name "*.jsx" | grep -v node_modules | wc -l)" >> health-report.md
        echo "- **Test files**: $(find . -name "*.test.*" -o -name "*.spec.*" | grep -v node_modules | wc -l)" >> health-report.md
        
        # Check for TODO comments
        echo "" >> health-report.md
        echo "### Development Notes:" >> health-report.md
        echo "- **TODO comments**: $(grep -r "TODO\|FIXME\|HACK" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" . | grep -v node_modules | wc -l)" >> health-report.md
        echo "- **Console statements**: $(grep -r "console.log\|console.warn\|console.error" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" . | grep -v node_modules | wc -l)" >> health-report.md
        
    - name: Check dependencies health
      run: |
        echo "" >> health-report.md
        echo "## üì¶ Dependencies Health" >> health-report.md
        echo "" >> health-report.md
        
        # Check package.json
        if [ -f "package.json" ]; then
          echo "### Package Information:" >> health-report.md
          echo "- **Node version requirement**: $(grep -o '"node":.*' package.json | cut -d'"' -f4 || echo 'Not specified')" >> health-report.md
          echo "- **Dependencies count**: $(cat package.json | jq '.dependencies | keys | length' 2>/dev/null || echo 'N/A')" >> health-report.md
          echo "- **Dev dependencies count**: $(cat package.json | jq '.devDependencies | keys | length' 2>/dev/null || echo 'N/A')" >> health-report.md
          
          # Check for outdated packages
          echo "" >> health-report.md
          echo "### Outdated Packages:" >> health-report.md
          npm outdated --json > outdated.json 2>/dev/null || echo "Unable to check outdated packages" >> health-report.md
          if [ -f outdated.json ] && [ -s outdated.json ]; then
            cat outdated.json | jq -r 'to_entries[] | "- \(.key): \(.value.current) ‚Üí \(.value.latest)"' >> health-report.md
          else
            echo "- ‚úÖ All packages up to date" >> health-report.md
          fi
        fi
        
    - name: Check build and test status
      run: |
        echo "" >> health-report.md
        echo "## üèóÔ∏è Build & Test Status" >> health-report.md
        echo "" >> health-report.md
        
        # Try to build
        echo "### Build Test:" >> health-report.md
        if npm run build > build.log 2>&1; then
          echo "- ‚úÖ Build successful" >> health-report.md
        else
          echo "- ‚ùå Build failed" >> health-report.md
          echo "Build errors:" >> health-report.md
          echo '```' >> health-report.md
          tail -20 build.log >> health-report.md
          echo '```' >> health-report.md
        fi
        
        # Try to run tests
        echo "" >> health-report.md
        echo "### Test Status:" >> health-report.md
        if npm run test > test.log 2>&1; then
          echo "- ‚úÖ Tests passing" >> health-report.md
        else
          echo "- ‚ùå Tests failing" >> health-report.md
          echo "Test errors:" >> health-report.md
          echo '```' >> health-report.md
          tail -20 test.log >> health-report.md
          echo '```' >> health-report.md
        fi
        
        # Try linting
        echo "" >> health-report.md
        echo "### Lint Status:" >> health-report.md
        if npm run lint > lint.log 2>&1; then
          echo "- ‚úÖ Linting passed" >> health-report.md
        else
          echo "- ‚ö†Ô∏è Linting issues found" >> health-report.md
          echo "Lint issues:" >> health-report.md
          echo '```' >> health-report.md
          tail -10 lint.log >> health-report.md
          echo '```' >> health-report.md
        fi
        
    - name: Check documentation
      run: |
        echo "" >> health-report.md
        echo "## üìö Documentation Status" >> health-report.md
        echo "" >> health-report.md
        
        # Check documentation files
        echo "### Documentation Files:" >> health-report.md
        doc_files=("README.md" "CONTRIBUTING.md" "docs/README.md" "AGENTS.md")
        for file in "${doc_files[@]}"; do
          if [ -f "$file" ]; then
            size=$(wc -c < "$file")
            echo "- ‚úÖ $file (${size} bytes)" >> health-report.md
          else
            echo "- ‚ùå $file (missing)" >> health-report.md
          fi
        done
        
        # Check for inline documentation
        echo "" >> health-report.md
        echo "### Code Documentation:" >> health-report.md
        echo "- **JSDoc comments**: $(grep -r "/\*\*" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" . | grep -v node_modules | wc -l)" >> health-report.md
        echo "- **TypeScript interfaces**: $(grep -r "interface " --include="*.ts" --include="*.tsx" . | grep -v node_modules | wc -l)" >> health-report.md
        echo "- **Type definitions**: $(grep -r "type " --include="*.ts" --include="*.tsx" . | grep -v node_modules | wc -l)" >> health-report.md
        
    - name: Generate health score
      run: |
        echo "" >> health-report.md
        echo "## üéØ Overall Health Score" >> health-report.md
        echo "" >> health-report.md
        
        # Calculate a simple health score
        score=0
        
        # Essential files (20 points)
        [ -f "README.md" ] && ((score+=5))
        [ -f "package.json" ] && ((score+=5))
        [ -f ".gitignore" ] && ((score+=5))
        [ -f "next.config.js" ] && ((score+=5))
        
        # Build status (20 points)
        npm run build > /dev/null 2>&1 && ((score+=20))
        
        # Test status (20 points)
        npm run test > /dev/null 2>&1 && ((score+=20))
        
        # Documentation (20 points)
        [ -f "README.md" ] && ((score+=10))
        [ -d "docs" ] && ((score+=10))
        
        # Code quality (20 points)
        npm run lint > /dev/null 2>&1 && ((score+=20))
        
        echo "### Score Breakdown:" >> health-report.md
        echo "- **Essential Files**: $([ -f "README.md" ] && echo "5/5" || echo "0/5") + $([ -f "package.json" ] && echo "5/5" || echo "0/5") + $([ -f ".gitignore" ] && echo "5/5" || echo "0/5") + $([ -f "next.config.js" ] && echo "5/5" || echo "0/5") = 20/20" >> health-report.md
        echo "- **Build Status**: $(npm run build > /dev/null 2>&1 && echo "20/20" || echo "0/20")" >> health-report.md
        echo "- **Test Status**: $(npm run test > /dev/null 2>&1 && echo "20/20" || echo "0/20")" >> health-report.md
        echo "- **Documentation**: $([ -f "README.md" ] && echo "10/10" || echo "0/10") + $([ -d "docs" ] && echo "10/10" || echo "0/10") = 20/20" >> health-report.md
        echo "- **Code Quality**: $(npm run lint > /dev/null 2>&1 && echo "20/20" || echo "0/20")" >> health-report.md
        echo "" >> health-report.md
        echo "### Total Score: $score/100" >> health-report.md
        
        if [ $score -ge 90 ]; then
          echo "### üü¢ Excellent Health" >> health-report.md
        elif [ $score -ge 70 ]; then
          echo "### üü° Good Health" >> health-report.md
        elif [ $score -ge 50 ]; then
          echo "### üü† Fair Health" >> health-report.md
        else
          echo "### üî¥ Poor Health" >> health-report.md
        fi
        
        echo "" >> health-report.md
        echo "### üìà Recommendations:" >> health-report.md
        if [ $score -lt 100 ]; then
          echo "- Address failed checks to improve score" >> health-report.md
        fi
        echo "- Keep dependencies updated" >> health-report.md
        echo "- Maintain test coverage" >> health-report.md
        echo "- Document new features" >> health-report.md
        echo "- Regular code reviews" >> health-report.md
        
    - name: Upload health report
      uses: actions/upload-artifact@v4
      with:
        name: health-report
        path: health-report.md
        
    - name: Comment PR with health results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          if (fs.existsSync('health-report.md')) {
            const report = fs.readFileSync('health-report.md', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## üè• Repository Health Check Complete\n\n${report}`
            });
          }

  workflow-status:
    runs-on: ubuntu-latest
    needs: health-check
    if: always()
    
    steps:
    - name: Check workflow status
      run: |
        if [ "${{ needs.health-check.result }}" == "success" ]; then
          echo "‚úÖ All health checks passed"
        else
          echo "‚ùå Some health checks failed"
          exit 1
        fi