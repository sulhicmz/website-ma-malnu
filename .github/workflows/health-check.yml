name: Repository Health Check

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  health-check:
    runs-on: ubuntu-latest
    name: Repository Health Check
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Check repository size
        run: |
          echo "Repository size:"
          du -sh .git
          echo "Working directory size:"
          du -sh .
          
      - name: Check for large files
        run: |
          echo "Files larger than 5MB:"
          find . -type f -size +5M -not -path "./.git/*" -exec ls -lh {} \;
          
      - name: Check for unused dependencies
        run: |
          npm install -g depcheck
          depcheck --json=depcheck-report.json || true
          
      - name: Check for outdated dependencies
        run: |
          npm outdated --json > outdated-report.json || true
          
      - name: Check code coverage
        run: |
          npm run test -- --coverage --coverageReporters=json || true
          
      - name: Check bundle size
        run: |
          npm run build
          npx bundlesize || true
          
      - name: Generate health report
        run: |
          cat > health-report.md << 'EOF'
          # Repository Health Report
          
          Generated on: $(date)
          
          ## Repository Statistics
          - Total size: $(du -sh . | cut -f1)
          - Git size: $(du -sh .git | cut -f1)
          - Total files: $(find . -type f -not -path "./.git/*" | wc -l)
          
          ## Dependencies
          - Total dependencies: $(cat package.json | jq '.dependencies | keys | length')
          - Dev dependencies: $(cat package.json | jq '.devDependencies | keys | length')
          
          ## Branch Information
          - Default branch: $(git symbolic-ref refs/remotes/origin/HEAD | sed 's@^.*/@@')
          - Total branches: $(git branch -a | wc -l)
          
          ## Recent Activity
          - Last commit: $(git log -1 --format="%h %s (%cr)")
          - Total commits: $(git rev-list --count HEAD)
          
          EOF
          
      - name: Upload reports
        uses: actions/upload-artifact@v4
        with:
          name: health-reports
          path: |
            depcheck-report.json
            outdated-report.json
            health-report.md
          retention-days: 30