@echo off
REM Security Setup Test Script for Windows
REM This script tests all security workflows and configurations

echo ğŸ”’ Testing Security Setup for sulhicmz/website-ma-malnu
echo ==================================================

REM Check if GitHub CLI is installed
echo ğŸ” Checking GitHub CLI...
gh --version >nul 2>&1
if %errorlevel% neq 0 (
    echo âŒ GitHub CLI is not installed
    echo Please install GitHub CLI: https://cli.github.com/
    pause
    exit /b 1
) else (
    echo âœ… GitHub CLI is installed
    gh --version
)

REM Test repository access
echo.
echo ğŸ” Testing Repository Access...
gh repo view sulhicmz/website-ma-malnu >nul 2>&1
if %errorlevel% neq 0 (
    echo âŒ Cannot access repository
    echo Please check your GitHub authentication
    pause
    exit /b 1
) else (
    echo âœ… Repository access confirmed
)

REM Test security workflows
echo.
echo ğŸ” Testing Security Workflows...
if exist ".github\workflows\security.yml" (
    echo âœ… security.yml exists
) else (
    echo âŒ security.yml not found
)

if exist ".github\workflows\advanced-security.yml" (
    echo âœ… advanced-security.yml exists
) else (
    echo âŒ advanced-security.yml not found
)

if exist ".github\workflows\security-monitoring.yml" (
    echo âœ… security-monitoring.yml exists
) else (
    echo âŒ security-monitoring.yml not found
)

if exist ".github\workflows\static-analysis.yml" (
    echo âœ… static-analysis.yml exists
) else (
    echo âŒ static-analysis.yml not found
)

if exist ".github\workflows\emergency-security.yml" (
    echo âœ… emergency-security.yml exists
) else (
    echo âŒ emergency-security.yml not found
)

REM Test Dependabot configuration
echo.
echo ğŸ” Testing Dependabot Configuration...
if exist ".github\dependabot.yml" (
    echo âœ… dependabot.yml exists
) else (
    echo âŒ dependabot.yml not found
)

REM Test CodeQL configuration
echo.
echo ğŸ” Testing CodeQL Configuration...
if exist ".github\codeql\codeql-config.yml" (
    echo âœ… CodeQL configuration exists
) else (
    echo âŒ CodeQL configuration not found
)

REM Test security policy
echo.
echo ğŸ” Testing Security Policy...
if exist "SECURITY.md" (
    echo âœ… SECURITY.md exists
) else (
    echo âŒ SECURITY.md not found
)

REM Test package.json
echo.
echo ğŸ” Testing Package Security...
if exist "package.json" (
    echo âœ… package.json exists
    
    echo Running npm audit...
    npm audit --audit-level=moderate
    if %errorlevel% equ 0 (
        echo âœ… No moderate or high vulnerabilities found
    ) else (
        echo âŒ Vulnerabilities found - check npm audit output
    )
) else (
    echo âŒ package.json not found
)

REM Test environment files
echo.
echo ğŸ” Testing Environment Files...
if exist ".env.example" (
    echo âœ… .env.example exists
) else (
    echo âŒ .env.example not found
)

if exist ".env.local.example" (
    echo âœ… .env.local.example exists
) else (
    echo âŒ .env.local.example not found
)

REM Generate report
echo.
echo ğŸ” Generating Security Test Report...
set report_file=security-test-report-%date:~-4,4%%date:~-10,2%%date:~-7,2%-%time:~0,2%%time:~3,2%%time:~6,2%.md
set report_file=%report_file: =0%

# Security Setup Test Report > %report_file%
echo **Repository**: sulhicmz/website-ma-malnu >> %report_file%
echo **Date**: %date% %time% >> %report_file%
echo **Tested by**: >> %report_file%
gh api user --jq '.login' >> %report_file%
echo. >> %report_file%

echo ## Test Summary >> %report_file%
echo This report contains the results of the security setup test. >> %report_file%
echo. >> %report_file%

echo ## Tests Performed >> %report_file%
echo 1. âœ… GitHub CLI access >> %report_file%
echo 2. âœ… Repository access >> %report_file%
echo 3. âœ… Security workflows validation >> %report_file%
echo 4. âœ… Dependabot configuration >> %report_file%
echo 5. âœ… CodeQL configuration >> %report_file%
echo 6. âœ… Security policy >> %report_file%
echo 7. âœ… Package security >> %report_file%
echo 8. âœ… Environment files >> %report_file%
echo. >> %report_file%

echo ## Next Steps >> %report_file%
echo 1. Review any failed tests >> %report_file%
echo 2. Configure missing secrets in GitHub repository settings >> %report_file%
echo 3. Enable Advanced Security features in repository settings >> %report_file%
echo 4. Monitor workflow runs in Actions tab >> %report_file%
echo 5. Set up security notifications >> %report_file%
echo. >> %report_file%

echo ---
echo *Generated by security test script* >> %report_file%

echo âœ… Security test report generated: %report_file%

echo.
echo ==================================================
echo ğŸ‰ Security setup test completed!
echo ğŸ“Š Check the generated report for details
echo ğŸ”§ Review any failed tests and follow the setup guide
echo ==================================================

pause